---

- name: Check the unit
  import_tasks: "check-unit.yml"

- name: Stop the unit
  block:
    - name: "Stop the {{ unit_name }} unit"
      systemd:
        name: "{{ unit_name }}"
        state: stopped
        daemon_reload: yes

    - name: "Ensure if the {{ unit_name }} unit is really stopped within 2 minutes"
      shell: "systemctl status {{ unit_name }} | grep 'Active:' | cut -f2 -d'(' | cut -f1 -d')' | awk '{print($1)}'"
      register: stop_status
      until: not stop_status.stdout|regex_search('running')
      retries: 24
      delay: 5
  when:
    - check_unit.stat.exists
